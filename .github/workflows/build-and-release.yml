name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build and Create Release
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore WakFocus/WakFocus.csproj

    - name: Build Release (Framework-dependent)
      run: dotnet publish WakFocus/WakFocus.csproj -c Release -o ./publish/framework-dependent

    - name: Build Release (Self-contained)
      run: dotnet publish WakFocus/WakFocus.csproj -c Release -r win-x64 --self-contained -o ./publish/self-contained

    - name: Rename executables and generate checksums
      shell: pwsh
      run: |
        # Rename files to avoid duplicate names
        Copy-Item "./publish/framework-dependent/WakFocus.exe" -Destination "./WakFocus-framework-dependent.exe"
        Copy-Item "./publish/self-contained/WakFocus.exe" -Destination "./WakFocus-self-contained.exe"

        $frameworkHash = (Get-FileHash -Path "./WakFocus-framework-dependent.exe" -Algorithm SHA256).Hash
        $selfContainedHash = (Get-FileHash -Path "./WakFocus-self-contained.exe" -Algorithm SHA256).Hash

        @"
        # SHA256 Checksums

        ## WakFocus-framework-dependent.exe
        ``````
        $frameworkHash
        ``````

        ## WakFocus-self-contained.exe
        ``````
        $selfContainedHash
        ``````

        ## How to verify
        On Windows PowerShell:
        ``````powershell
        Get-FileHash -Path WakFocus-*.exe -Algorithm SHA256
        ``````
        "@ | Out-File -FilePath checksums.txt -Encoding UTF8

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          WakFocus-framework-dependent.exe
          WakFocus-self-contained.exe
          checksums.txt
        body: |
          ## Downloads

          - **WakFocus-framework-dependent.exe** - Requires .NET 8.0 Runtime (~200KB)
          - **WakFocus-self-contained.exe** - No runtime required (~60MB)

          Rename the downloaded file to `WakFocus.exe` after downloading.

          ## Security

          - âœ… Built automatically by GitHub Actions
          - âœ… SHA256 checksums provided (see checksums.txt)
          - âœ… Source code scanned with CodeQL
          - ðŸ”’ VirusTotal scan results will be posted shortly

          ## Verification

          Download `checksums.txt` and verify the SHA256 hash matches your downloaded executable.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
